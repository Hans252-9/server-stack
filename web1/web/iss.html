<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="refresh" content="60">
  <title>ISS tracker ultra simple</title>

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      gap: 10px;
    }

    #panel {
      color: #fff;
      background: rgba(0,0,0,0.6);
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.4;
      padding: 8px 10px;
      min-width: 180px;
      text-align: left;
      white-space: pre-line;
    }

    #wrap {
      position: relative;
      max-width: 90vw;
      max-height: 70vh;
      /* drž poměr obrázku: šířka podle okna, výška se dopočítá */
    }

    #world {
      display: block;
      width: 100%;
      height: auto;
    }

    #overlay {
      position: absolute;
      left: 0;
      top: 0;
      /* canvas se roztáhne JS podle rozměrů obrázku */
    }
  </style>
</head>
<body>

<div id="panel">Načítám ISS…</div>

<div id="wrap">
  <img id="world" src="world.jpg" alt="world map">
  <canvas id="overlay"></canvas>
</div>

<script>
async function main() {
  const panel = document.getElementById('panel');
  const img = document.getElementById('world');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  // počkáme, až se obrázek načte (potřebujeme jeho rozměry)
  await imageLoaded(img);

  // nastavíme canvas na stejnou velikost v pixelech jako vykreslený obrázek
  const rect = img.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';

  // pomocné funkce pro převod lat/lon -> x,y v pixelech
  function lonToX(lon) {
    // lon -180..180 => 0..width
    return ( (lon + 180) / 360 ) * canvas.width;
  }

  function latToY(lat) {
    // lat 90..-90 => 0..height
    return ( (90 - lat) / 180 ) * canvas.height;
  }

  // načteme historickou stopu
  let trackData = [];
  try {
    const rTrack = await fetch('/iss_track.php');
    trackData = await rTrack.json(); // [ {latitude, longitude, ...}, ... ]
  } catch (e) {
    console.error('Chyba track:', e);
  }

  // vykreslit dráhu ISS
  if (trackData.length > 1) {
    ctx.strokeStyle = 'yellow';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i = 0; i < trackData.length; i++) {
  const lat = trackData[i].latitude;
  const lon = trackData[i].longitude;
  const x = lonToX(lon);
  const y = latToY(lat);

  if (i === 0) {
    ctx.moveTo(x, y);
  } else {
    const prevLon = trackData[i - 1].longitude;
    // Pokud rozdíl dlouh. > 180°, znamená to, že ISS přešla přes okraj mapy
    if (Math.abs(lon - prevLon) > 180) {
      ctx.stroke();        // uzavři starou čáru
      ctx.beginPath();     // začni novou
      ctx.moveTo(x, y);    // navazuj od nového bodu
    } else {
      ctx.lineTo(x, y);
    }
  }
}
ctx.stroke();

  }

  // načteme aktuální pozici ISS
  let issData = null;
  try {
    const rISS = await fetch('/iss.php');
    issData = await rISS.json(); // {latitude, longitude, ...}
  } catch (e) {
    console.error('Chyba iss:', e);
  }

  if (issData) {
    const lat = issData.latitude;
    const lon = issData.longitude;
    const x = lonToX(lon);
    const y = latToY(lat);

    // červená ISS tečka
    ctx.fillStyle = 'red';
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI*2);
    ctx.fill();

    // bílý okraj kolem
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;
    ctx.stroke();

    // update panelu
    panel.textContent = `ISS ONLINE
Lat: ${lat.toFixed(2)}
Lon: ${lon.toFixed(2)}`;
  } else {
    panel.textContent = `ISS OFFLINE
Nedostupná data`;
  }
}

// helper: vrátí Promise, který se resolve, až je <img> načtený
function imageLoaded(imgEl) {
  return new Promise(resolve => {
    if (imgEl.complete) {
      resolve();
    } else {
      imgEl.onload = () => resolve();
      imgEl.onerror = () => resolve();
    }
  });
}

main();
</script>

</body>
</html>
